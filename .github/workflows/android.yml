name: Android Build + Dynamic Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_API_LEVEL: 30
      ANDROID_NDK_VERSION: 25.2.9519653
      BUILD_TYPE: Release

    steps:
    # ------------------------------------------------------------
    # Checkout repository (with submodules)
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Verify checkout
      run: |
        echo "Repository root:"
        ls -la
        echo "Submodules:"
        git submodule status

    # ------------------------------------------------------------
    # Import dynamic assets
    # ------------------------------------------------------------
    - name: Import dynamic assets
      run: |
        set -e
        ASSET_DST="android/app/src/main/assets"
        mkdir -p "$ASSET_DST"

        echo "Copying assets into $ASSET_DST"
        if [ -d "assets" ]; then
          cp -R assets/* "$ASSET_DST/"
        fi

        echo "Assets imported:"
        find "$ASSET_DST" -maxdepth 3 || true

    # ------------------------------------------------------------
    # Patch lib/rt64 CMakeLists.txt (Android-safe, PC-aligned)
    # ------------------------------------------------------------
    - name: Patch RT64 CMakeLists.txt for Android
      run: |
        set -e

        FILE="lib/rt64/CMakeLists.txt"

        echo "Patching $FILE"

        cp "$FILE" "$FILE.bak"

        python3 << 'EOF'
from pathlib import Path

path = Path("lib/rt64/CMakeLists.txt")
text = path.read_text()

marker = "### ANDROID CI PATCH START"
if marker in text:
    print("Patch already applied")
    exit(0)

patch = r'''
### ANDROID CI PATCH START
if(ANDROID)
    message(STATUS "RT64 Android build detected")

    foreach(dir
        ${CMAKE_CURRENT_SOURCE_DIR}/external
        ${CMAKE_CURRENT_SOURCE_DIR}/external/volk
        ${CMAKE_CURRENT_SOURCE_DIR}/external/Vulkan-Headers/include
    )
        if(EXISTS ${dir})
            include_directories(${dir})
        else()
            message(STATUS "Skipping missing include dir: ${dir}")
        endif()
    endforeach()
endif()
### ANDROID CI PATCH END
'''

text += patch
path.write_text(text)
print("RT64 Android patch applied")
EOF

        echo "Patch diff:"
        diff -u "$FILE.bak" "$FILE" || true

    # ------------------------------------------------------------
    # Setup Java
    # ------------------------------------------------------------
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # ------------------------------------------------------------
    # Setup Android SDK / NDK
    # ------------------------------------------------------------
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android NDK
      run: |
        sdkmanager --install "ndk;${ANDROID_NDK_VERSION}"

    - name: Verify Android tools
      run: |
        echo "SDK Root: $ANDROID_SDK_ROOT"
        ls "$ANDROID_SDK_ROOT/ndk"

    # ------------------------------------------------------------
    # Configure CMake (Android)
    # ------------------------------------------------------------
    - name: Configure CMake
      run: |
        set -e
        mkdir -p build/android
        cd build/android

        cmake ../.. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-${ANDROID_API_LEVEL} \
          -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
          -DBUILD_SHARED_LIBS=OFF

    # ------------------------------------------------------------
    # Build native libraries
    # ------------------------------------------------------------
    - name: Build native code
      run: |
        set -e
        cd build/android
        cmake --build . --config ${BUILD_TYPE} -- -j$(nproc)

    # ------------------------------------------------------------
    # Build APK via Gradle
    # ------------------------------------------------------------
    - name: Build APK
      run: |
        set -e
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --stacktrace

    # ------------------------------------------------------------
    # Upload APK
    # ------------------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/**/*.apk