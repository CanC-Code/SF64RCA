name: Android Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_ABI: arm64-v8a
      ANDROID_PLATFORM: android-34
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64

    steps:
    # ------------------------------------------------------------
    # Checkout repository (recursive submodules)
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    # ------------------------------------------------------------
    # Set up JDK 17
    # ------------------------------------------------------------
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    # ------------------------------------------------------------
    # Set up Android SDK and NDK
    # ------------------------------------------------------------
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK & Build Tools
      run: |
        sdkmanager --install "ndk;27.3.13750724" "platforms;android-34" "build-tools;34.0.0"

    # ------------------------------------------------------------
    # Verify required submodules exist
    # ------------------------------------------------------------
    - name: Verify submodules
      run: |
        test -f android/RmlUi/CMakeLists.txt
        test -f android/SDL2/CMakeLists.txt
        test -d android/freetype

    # ------------------------------------------------------------
    # Patch RmlUi backend for Android
    # ------------------------------------------------------------
    - name: Patch RmlUi for Android
      run: |
        RMLUI=android/RmlUi/CMakeLists.txt
        cp "$RMLUI" "$RMLUI.bak"
        awk '
          BEGIN { injected=0 }
          {
            print
            if ($0 ~ /^project\(/ && injected==0) {
              injected=1
              print ""
              print "# ---- Android forced configuration ----"
              print "set(RMLUI_BACKEND SDL_GL3 CACHE STRING \"Android backend\" FORCE)"
              print "set(RMLUI_SAMPLES OFF CACHE BOOL \"\" FORCE)"
              print "set(RMLUI_SHELL OFF CACHE BOOL \"\" FORCE)"
              print "set(RMLUI_LUA_BINDINGS OFF CACHE BOOL \"\" FORCE)"
              print "set(RMLUI_LOTTIE_PLUGIN OFF CACHE BOOL \"\" FORCE)"
              print "set(RMLUI_SVG_PLUGIN OFF CACHE BOOL \"\" FORCE)"
              print "set(RMLUI_HARFBUZZ_SAMPLE OFF CACHE BOOL \"\" FORCE)"
              print "set(BUILD_TESTING OFF CACHE BOOL \"\" FORCE)"
              print "set(BUILD_SHARED_LIBS OFF CACHE BOOL \"\" FORCE)"
              print "# ---- End Android configuration ----"
            }
          }
        ' "$RMLUI.bak" > "$RMLUI"
        diff -u "$RMLUI.bak" "$RMLUI" || true

    # ------------------------------------------------------------
    # Remove stale CMake cache
    # ------------------------------------------------------------
    - name: Remove stale CMake cache
      run: rm -rf android/app/.cxx

    # ------------------------------------------------------------
    # Convert assets to C source
    # ------------------------------------------------------------
    - name: Make file_to_c executable
      run: chmod +x ./file_to_c

    - name: Convert assets to C
      run: |
        mkdir -p android/app/src/main/cmods android/app/src/main/cassets
        for f in assets/*.nrm; do
          [ -f "$f" ] || continue
          name=$(basename "$f" .nrm)
          ./file_to_c "$f" "$name" \
            android/app/src/main/cmods/${name}.c \
            android/app/src/main/cmods/${name}.h
        done

        shopt -s globstar nullglob
        for f in assets/**/*.{png,jpg,jpeg,svg,ttf,otf}; do
          name=$(basename "$f")
          name="${name%.*}"
          ./file_to_c "$f" "$name" \
            android/app/src/main/cassets/${name}.c \
            android/app/src/main/cassets/${name}.h
        done

    # ------------------------------------------------------------
    # Build APK inside android/
    # ------------------------------------------------------------
    - name: Build Debug APK
      working-directory: android
      run: ./gradlew :app:assembleDebug --no-daemon --stacktrace

    # ------------------------------------------------------------
    # Upload APK artifact
    # ------------------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Starfox64RCA-debug
        path: android/app/build/outputs/apk/debug/app-debug.apk