name: Android Build + Dynamic Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    # --- Checkout repository ---
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- Install minimal system dependencies ---
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget gcc

    # --- Setup JDK 17 ---
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- Setup Android SDK ---
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.2.9519653
        cmake: 3.22.1

    # --- Make gradlew executable ---
    - name: Make gradlew executable
      run: chmod +x android/gradlew

    # --- Build file_to_c utility ---
    - name: Build file_to_c utility
      run: |
        cat > /tmp/file_to_c.c << 'EOF'
        #include <stdio.h>
        #include <stdlib.h>
        #include <string.h>
        int main(int argc, char *argv[]) {
            if (argc != 5) { fprintf(stderr, "Usage: %s <input_file> <symbol_name> <output_c> <output_h>\n", argv[0]); return 1; }
            const char *infile = argv[1], *sym = argv[2], *cfile = argv[3], *hfile = argv[4];
            FILE *in=fopen(infile,"rb"); if(!in){fprintf(stderr,"Cannot open %s\n",infile);return 1;}
            fseek(in,0,SEEK_END); long size=ftell(in); fseek(in,0,SEEK_SET);
            FILE *h=fopen(hfile,"w"); if(!h){fclose(in);fprintf(stderr,"Cannot create %s\n",hfile);return 1;}
            fprintf(h,"#ifndef %s_H\n#define %s_H\n\nextern const unsigned char %s[];\nextern const unsigned int %s_size;\n\n#endif\n", sym,sym,sym,sym); fclose(h);
            FILE *c=fopen(cfile,"w"); if(!c){fclose(in);fprintf(stderr,"Cannot create %s\n",cfile);return 1;}
            fprintf(c,"#include \"%s\"\n\nconst unsigned char %s[] = {\n", strrchr(hfile,'/')?strrchr(hfile,'/')+1:hfile, sym);
            unsigned char b; long count=0; while(fread(&b,1,1,in)==1){if(count%16==0)fprintf(c,"    "); fprintf(c,"0x%02x",b); count++; if(count<size){fprintf(c,","); if(count%16==0)fprintf(c,"\n"); else fprintf(c," ");}}
            fprintf(c,"\n};\n\nconst unsigned int %s_size = %ld;\n", sym,size); fclose(in); fclose(c); return 0;
        }
        EOF
        gcc /tmp/file_to_c.c -o /tmp/file_to_c
        sudo mv /tmp/file_to_c /usr/local/bin/file_to_c
        sudo chmod +x /usr/local/bin/file_to_c
        file_to_c --version || echo "file_to_c ready"

    # --- Prepare Android launcher icon ---
    - name: Prepare Android launcher icon
      run: |
        RES_DIR=android/app/src/main/res/mipmap-anydpi-v26
        mkdir -p "$RES_DIR"
        cp icons/512.png "$RES_DIR/ic_launcher.png"
        echo "Launcher icon prepared."

    # --- Copy assets dynamically ---
    - name: Copy assets to Android project
      run: |
        rm -rf android/app/src/main/assets
        cp -R assets android/app/src/main/

    # --- Generate shader headers ---
    - name: Generate shader headers dynamically
      run: |
        mkdir -p android/app/src/main/cshaders
        if ls shaders/*.hlsl 1> /dev/null 2>&1; then
          for f in shaders/*.hlsl; do
              base=$(basename "$f" .hlsl)
              file_to_c "$f" "shader_${base}" "android/app/src/main/cshaders/${base}.c" "android/app/src/main/cshaders/${base}.h"
          done
        fi

    # --- Generate mod headers dynamically ---
    - name: Generate mod headers dynamically
      run: |
        mkdir -p android/app/src/main/cmods
        if ls mods/*.nrm 1> /dev/null 2>&1; then
          for f in mods/*.nrm; do
              base=$(basename "$f" .nrm)
              file_to_c "$f" "$base" "android/app/src/main/cmods/${base}.c" "android/app/src/main/cmods/${base}.h"
          done
        fi

    # --- Generate patches_bin.c dynamically ---
    - name: Generate patches_bin.c dynamically
      run: |
        mkdir -p android/app/src/main/cpatches
        if [ -f patches/patches.bin ]; then
          file_to_c patches/patches.bin mm_patches_bin android/app/src/main/cpatches/patches_bin.c android/app/src/main/cpatches/patches_bin.h
        fi

    # --- Cache Gradle dependencies ---
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    # --- Build APK ---
    - name: Build Android APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    # --- Verify APK ---
    - name: Verify APK exists and signature
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        if [ ! -f "$APK_PATH" ]; then
          echo "APK not found! Build failed."
          exit 1
        fi
        echo "APK found: $APK_PATH"
        echo "Verifying APK signature..."
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify "$APK_PATH"
        echo "APK verification passed. APK is installable."

    # --- Test APK on Emulator ---
    - name: Test APK on Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        target: google_apis
        arch: x86_64
        profile: Pixel_6
        emulator-options: -no-window -noaudio -gpu swiftshader_indirect
        emulator-boot-timeout: 600
        force-avd-creation: true
        avd-name: test
        cores: 2
        disable-animations: true
        script: |
          echo "Waiting for emulator..."
          adb wait-for-device
          echo "Installing APK..."
          adb install -r android/app/build/outputs/apk/debug/app-debug.apk
          echo "Launching APK for basic functional test..."
          adb shell monkey -p com.canccode.sf64rca -c android.intent.category.LAUNCHER 1

    # --- Upload APK artifact ---
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: SF64RCA-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        if-no-files-found: error