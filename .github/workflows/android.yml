name: Android Build & Generate Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      GITHUB_WORKSPACE: ${{ github.workspace }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget

    - name: Cache file_to_c build
      uses: actions/cache@v3
      with:
        path: /tmp/mupen64plus-core/utils/file_to_c/build/file_to_c
        key: file_to_c-${{ runner.os }}-v1
        restore-keys: |
          file_to_c-${{ runner.os }}-

    - name: Build file_to_c from Mupen64Plus source if cache missed
      run: |
        if [ ! -f /tmp/mupen64plus-core/utils/file_to_c/build/file_to_c ]; then
          git clone --depth 1 https://github.com/mupen64plus/mupen64plus-core.git /tmp/mupen64plus-core
          cd /tmp/mupen64plus-core/utils/file_to_c
          mkdir -p build && cd build
          cmake ..
          make
          sudo cp file_to_c /usr/local/bin/
        else
          echo "Using cached file_to_c"
          sudo cp /tmp/mupen64plus-core/utils/file_to_c/build/file_to_c /usr/local/bin/
        fi
        file_to_c --version || echo "file_to_c installed"

    - name: Generate shaders, mods, and patches
      run: |
        mkdir -p generated_shaders generated_mods RecompiledPatches android/app/src/main/cmods

        echo "Generating HLSL shader headers..."
        for vs in shaders/*.hlsl; do
            name=$(basename "$vs")
            out="$GITHUB_WORKSPACE/generated_shaders/$name"
            file_to_c "$vs" "shader_$(basename $vs .hlsl)" "$out" "$out.h"
        done

        echo "Converting .nrm mods to C headers..."
        for mod in mods/*.nrm; do
            modname=$(basename "$mod" .nrm)
            out="$GITHUB_WORKSPACE/android/app/src/main/cmods/$modname.c"
            file_to_c "$mod" "$modname" "$out" "$out.h"
        done

        echo "Generating patches_bin.c..."
        if [ -f patches/patches.bin ]; then
            file_to_c patches/patches.bin mm_patches_bin RecompiledPatches/patches_bin.c RecompiledPatches/patches_bin.h
        else
            echo "Warning: patches/patches.bin not found; skipping patches_bin.c"
        fi

    - name: Build Android APK
      working-directory: android
      run: |
        ./gradlew assembleDebug --no-daemon