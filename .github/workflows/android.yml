name: Android Build + Dynamic Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Initialize submodules
      run: git submodule update --init --recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget gcc imagemagick

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.2.9519653
        cmake: 3.22.1

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    # ---------- file_to_c ----------
    - name: Build file_to_c utility
      run: |
        cat > /tmp/file_to_c.c << 'EOF'
        #include <stdio.h>
        #include <stdlib.h>
        int main(int argc,char**argv){
          if(argc!=5)return 1;
          FILE*i=fopen(argv[1],"rb"); if(!i)return 1;
          FILE*c=fopen(argv[3],"w"); FILE*h=fopen(argv[4],"w");
          fseek(i,0,SEEK_END); long s=ftell(i); fseek(i,0,SEEK_SET);
          fprintf(h,"extern const unsigned char %s[];\nextern const unsigned int %s_size;\n",argv[2],argv[2]);
          fprintf(c,"const unsigned char %s[]={",argv[2]);
          for(long j=0;j<s;j++){fprintf(c,"0x%02x,",fgetc(i));}
          fprintf(c,"};\nconst unsigned int %s_size=%ld;",argv[2],s);
        }
        EOF
        gcc /tmp/file_to_c.c -o /usr/local/bin/file_to_c
        chmod +x /usr/local/bin/file_to_c

    # ---------- Assets ----------
    - name: Copy assets
      run: |
        rm -rf android/app/src/main/assets
        cp -R assets android/app/src/main/

    # ---------- Build ----------
    - name: Build Android APK (FAIL FAST)
      working-directory: android
      run: |
        ./gradlew assembleDebug --no-daemon --stacktrace --info

    # ---------- Resolve APK ----------
    - name: Resolve APK path
      id: apk
      run: |
        APK=$(find android/app/build/outputs/apk -name "*.apk" | head -n 1)
        if [ -z "$APK" ]; then
          echo "❌ No APK produced"
          exit 1
        fi
        echo "apk_path=$APK" >> $GITHUB_OUTPUT
        echo "Found APK: $APK"

    # ---------- APK Verification ----------
    - name: APK sanity check
      run: |
        APK="${{ steps.apk.outputs.apk_path }}"
        unzip -t "$APK" > /dev/null
        $ANDROID_HOME/build-tools/34.0.0/aapt dump badging "$APK"
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify "$APK"

    # ---------- Upload ----------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SF64RCA-debug-apk
        path: ${{ steps.apk.outputs.apk_path }}
        if-no-files-found: error

    - name: Build summary
      run: |
        echo "## ✅ APK Built Successfully" >> $GITHUB_STEP_SUMMARY
        echo "**APK:** ${{ steps.apk.outputs.apk_path }}" >> $GITHUB_STEP_SUMMARY