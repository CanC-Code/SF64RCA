name: Android Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.3.13750724
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17

    steps:
      # ------------------------------------------------------------
      # Checkout repo (with submodules)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ------------------------------------------------------------
      # Install Java 17
      # ------------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ------------------------------------------------------------
      # Install Android SDK + NDK
      # ------------------------------------------------------------
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;27.3.13750724"

      # ------------------------------------------------------------
      # ðŸ”¥ FORCE RmlUi backend BEFORE CMake configure
      # ------------------------------------------------------------
      - name: Force RmlUi SDL_GL3 backend
        run: |
          RMLUI_CMAKE="SF64RCA/android/RmlUi/CMakeLists.txt"

          echo "Patching $RMLUI_CMAKE"

          # Safety check
          if ! grep -q "RmlUi" "$RMLUI_CMAKE"; then
            echo "ERROR: RmlUi CMakeLists.txt not found or unexpected format"
            exit 1
          fi

          # Inject FORCE cache line at the top
          sed -i '1i\
set(RMLUI_BACKEND SDL_GL3 CACHE STRING "RmlUi backend" FORCE)\n' "$RMLUI_CMAKE"

          echo "Injected RMLUI_BACKEND=SDL_GL3 (CACHE FORCE)"

      # ------------------------------------------------------------
      # Clean old CMake state (defensive, fast)
      # ------------------------------------------------------------
      - name: Clear previous native build cache
        run: |
          rm -rf android/app/.cxx

      # ------------------------------------------------------------
      # Build Android APK
      # ------------------------------------------------------------
      - name: Build Debug APK
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace