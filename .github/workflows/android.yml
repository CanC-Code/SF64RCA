name: Android Build + Generated Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 26.2.11394342

    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses

    - name: Install SDK components
      run: |
        sdkmanager \
          "platforms;android-34" \
          "build-tools;34.0.0"

    # === Build & Cache file_to_c ===
    - name: Cache file_to_c
      id: cache-filetoc
      uses: actions/cache@v3
      with:
        path: /usr/local/bin/file_to_c
        key: filetoc-${{ runner.os }}-v1

    - name: Build file_to_c tool
      if: steps.cache-filetoc.outputs.cache-hit != 'true'
      run: |
        echo "Cloning mupen64plus-core to find file_to_c..."
        git clone --depth 1 https://github.com/mupen64plus/mupen64plus-core.git /tmp/mupen64plus-core

        echo "Searching for file_to_c.c..."
        FILE_C=$(find /tmp/mupen64plus-core -name file_to_c.c | head -n1)
        if [ -z "$FILE_C" ]; then
          echo "Error: file_to_c.c not found; cannot build file_to_c"
          exit 1
        fi
        echo "Found file_to_c at $FILE_C"

        echo "Compiling file_to_c..."
        FILE_TO_C_BUILD=/tmp/file_to_c_build
        mkdir -p $FILE_TO_C_BUILD
        gcc "$FILE_C" -o "$FILE_TO_C_BUILD/file_to_c"
        sudo cp "$FILE_TO_C_BUILD/file_to_c" /usr/local/bin/
        chmod +x /usr/local/bin/file_to_c

        echo "file_to_c version:"
        file_to_c --version || true

    # === Generated Shaders Cache + Creation ===
    - name: Cache generated shaders
      id: shader-cache
      uses: actions/cache@v3
      with:
        path: generated_shaders
        key: shader-cache-${{ runner.os }}-${{ hashFiles('shaders/**/*.hlsl') }}

    - name: Generate HLSL shader headers
      if: steps.shader-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p generated_shaders
        for vs in shaders/*.hlsl; do
          fname=$(basename "$vs" .hlsl)
          file_to_c "$vs" "shader_${fname}" "generated_shaders/${fname}" "generated_shaders/${fname}.h"
        done

    # === Mod Headers Cache + Creation ===
    - name: Cache generated mod headers
      id: mod-cache
      uses: actions/cache@v3
      with:
        path: android/app/src/main/cmods
        key: mod-cache-${{ runner.os }}-${{ hashFiles('mods/**/*.nrm') }}

    - name: Convert .nrm mods to C headers
      if: steps.mod-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p android/app/src/main/cmods
        for mod in mods/*.nrm; do
          mname=$(basename "$mod" .nrm)
          file_to_c "$mod" "${mname}" "android/app/src/main/cmods/${mname}.c" "android/app/src/main/cmods/${mname}.h"
        done

    # === Patches Binary Cache + Creation ===
    - name: Cache patches_bin.c
      id: patches-cache
      uses: actions/cache@v3
      with:
        path: RecompiledPatches/patches_bin.c
        key: patches-cache-${{ runner.os }}-${{ hashFiles('patches/patches.bin') }}

    - name: Generate patches_bin.c
      if: steps.patches-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p RecompiledPatches
        if [ -f patches/patches.bin ]; then
          file_to_c patches/patches.bin mm_patches_bin RecompiledPatches/patches_bin.c RecompiledPatches/patches_bin.h
        else
          echo "Warning: patches/patches.bin not found"
        fi

    # === Gradle Cache ===
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          android/.gradle
          android/build
        key: gradle-${{ runner.os }}-v1

    # === Build the APK ===
    - name: Make Gradle wrapper executable
      run: chmod +x android/gradlew

    - name: Assemble Debug APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Starfox64RCA-debug-apk
        path: android/app/build/outputs/apk/debug/*.apk