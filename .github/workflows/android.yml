name: Android Build + file_to_c Generation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget gcc

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.2.9519653
        cmake: 3.22.1

    # --- Checkout mupen64plus-utils using actions/checkout ---
    - name: Checkout mupen64plus-utils
      uses: actions/checkout@v4
      with:
        repository: mupen64plus/mupen64plus-utils
        path: mupen64plus-utils
        ref: master

    # --- Cache file_to_c binary ---
    - name: Cache file_to_c binary
      id: file-to-c-cache
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/file_to_c
        key: file-to-c-${{ runner.os }}-v1

    # --- Build file_to_c ---
    - name: Build file_to_c from mupen64plus-utils
      if: steps.file-to-c-cache.outputs.cache-hit != 'true'
      run: |
        FILE_TO_C_BUILD=/tmp/file_to_c_build
        mkdir -p $FILE_TO_C_BUILD

        FILE_C=$GITHUB_WORKSPACE/mupen64plus-utils/file_to_c/file_to_c.c
        if [ ! -f "$FILE_C" ]; then
          echo "Error: file_to_c.c not found at $FILE_C"
          echo "Contents of mupen64plus-utils:"
          ls -la $GITHUB_WORKSPACE/mupen64plus-utils/ || true
          exit 1
        fi

        echo "Compiling file_to_c..."
        gcc "$FILE_C" -o "$FILE_TO_C_BUILD/file_to_c"
        sudo cp "$FILE_TO_C_BUILD/file_to_c" /usr/local/bin/
        sudo chmod +x /usr/local/bin/file_to_c

    - name: Verify file_to_c installation
      run: |
        echo "file_to_c location check:"
        which file_to_c || echo "file_to_c not in PATH"
        ls -la /usr/local/bin/file_to_c || echo "file_to_c binary not found"
        /usr/local/bin/file_to_c --version 2>&1 || echo "file_to_c installed successfully"

    # --- Cache generated shader headers ---
    - name: Cache generated shader headers
      id: shader-cache
      uses: actions/cache@v4
      with:
        path: generated_shaders
        key: shader-cache-${{ runner.os }}-${{ hashFiles('shaders/*.hlsl') }}

    - name: Generate HLSL shader headers
      if: steps.shader-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p generated_shaders
        if ls shaders/*.hlsl 1> /dev/null 2>&1; then
          for vs in shaders/*.hlsl; do
              name=$(basename "$vs")
              out="$GITHUB_WORKSPACE/generated_shaders/$name"
              /usr/local/bin/file_to_c "$vs" "shader_$(basename $vs .hlsl)" "$out" "$out.h"
          done
        else
          echo "No HLSL shader files found in shaders/"
        fi

    # --- Cache generated mod headers ---
    - name: Cache generated mod headers
      id: mod-cache
      uses: actions/cache@v4
      with:
        path: android/app/src/main/cmods
        key: mod-cache-${{ runner.os }}-${{ hashFiles('mods/*.nrm') }}

    - name: Convert .nrm mods to C headers
      if: steps.mod-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p android/app/src/main/cmods
        if ls mods/*.nrm 1> /dev/null 2>&1; then
          for mod in mods/*.nrm; do
              modname=$(basename "$mod" .nrm)
              out="$GITHUB_WORKSPACE/android/app/src/main/cmods/$modname.c"
              /usr/local/bin/file_to_c "$mod" "$modname" "$out" "$out.h"
          done
        else
          echo "No .nrm mod files found in mods/"
        fi

    # --- Cache patches_bin.c ---
    - name: Cache patches_bin.c
      id: patches-cache
      uses: actions/cache@v4
      with:
        path: RecompiledPatches/patches_bin.c
        key: patches-cache-${{ runner.os }}-${{ hashFiles('patches/patches.bin') }}

    - name: Generate patches_bin.c
      if: steps.patches-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p RecompiledPatches
        if [ -f patches/patches.bin ]; then
            /usr/local/bin/file_to_c patches/patches.bin mm_patches_bin RecompiledPatches/patches_bin.c RecompiledPatches/patches_bin.h
        else
            echo "Warning: patches/patches.bin not found; skipping patches_bin.c"
        fi

    # --- Cache Gradle wrapper and dependencies ---
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Build Android APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: SF64RCA-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        if-no-files-found: error