name: Build Starfox 64 Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Install Android SDK components
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip wget zip
        mkdir -p $ANDROID_SDK_ROOT
        cd $ANDROID_SDK_ROOT
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip
        rm cmdline-tools.zip
        mv cmdline-tools latest
        yes | $ANDROID_SDK_ROOT/latest/bin/sdkmanager --licenses
        $ANDROID_SDK_ROOT/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

    - name: Install CMake & Ninja
      run: |
        # CMake
        curl -L https://github.com/Kitware/CMake/releases/download/v3.27.3/cmake-3.27.3-linux-x86_64.sh -o cmake.sh
        chmod +x cmake.sh
        sudo mkdir -p /opt/cmake-3.27.3
        sudo chown $USER:$USER /opt/cmake-3.27.3
        ./cmake.sh --skip-license --prefix=/opt/cmake-3.27.3
        sudo ln -sf /opt/cmake-3.27.3/bin/cmake /usr/local/bin/cmake

        # Ninja
        sudo apt-get install -y ninja-build
        sudo ln -sf $(which ninja) /usr/local/bin/ninja

    - name: Show CMake & Ninja versions
      run: |
        cmake --version
        ninja --version

    - name: Build APK (debug)
      working-directory: android
      run: ./gradlew clean assembleDebug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: starfox64-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk