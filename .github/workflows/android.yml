name: Android Build + Dynamic Assets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    # --- Checkout repository ---
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- Install minimal system dependencies ---
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git unzip wget gcc zipalign

    # --- Setup JDK 17 ---
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- Setup Android SDK ---
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.2.9519653
        cmake: 3.22.1

    # --- Make gradlew executable ---
    - name: Make gradlew executable
      run: chmod +x android/gradlew

    # --- Build file_to_c utility ---
    - name: Build file_to_c utility
      run: |
        cat > /tmp/file_to_c.c << 'EOF'
        #include <stdio.h>
        #include <stdlib.h>
        #include <string.h>
        int main(int argc, char *argv[]) {
            if (argc != 5) { fprintf(stderr, "Usage: %s <input_file> <symbol_name> <output_c> <output_h>\n", argv[0]); return 1; }
            const char *infile = argv[1], *sym = argv[2], *cfile = argv[3], *hfile = argv[4];
            FILE *in=fopen(infile,"rb"); if(!in){fprintf(stderr,"Cannot open %s\n",infile);return 1;}
            fseek(in,0,SEEK_END); long size=ftell(in); fseek(in,0,SEEK_SET);
            FILE *h=fopen(hfile,"w"); if(!h){fclose(in);fprintf(stderr,"Cannot create %s\n",hfile);return 1;}
            fprintf(h,"#ifndef %s_H\n#define %s_H\n\nextern const unsigned char %s[];\nextern const unsigned int %s_size;\n\n#endif\n", sym,sym,sym,sym); fclose(h);
            FILE *c=fopen(cfile,"w"); if(!c){fclose(in);fprintf(stderr,"Cannot create %s\n",cfile);return 1;}
            fprintf(c,"#include \"%s\"\n\nconst unsigned char %s[] = {\n", strrchr(hfile,'/')?strrchr(hfile,'/')+1:hfile, sym);
            unsigned char b; long count=0; while(fread(&b,1,1,in)==1){if(count%16==0)fprintf(c,"    "); fprintf(c,"0x%02x",b); count++; if(count<size){fprintf(c,","); if(count%16==0)fprintf(c,"\n"); else fprintf(c," ");}}
            fprintf(c,"\n};\n\nconst unsigned int %s_size = %ld;\n", sym,size); fclose(in); fclose(c); return 0;
        }
        EOF
        gcc /tmp/file_to_c.c -o /tmp/file_to_c
        sudo mv /tmp/file_to_c /usr/local/bin/file_to_c
        sudo chmod +x /usr/local/bin/file_to_c
        echo "file_to_c utility built successfully"

    # --- Prepare Android launcher icons ---
    - name: Prepare Android launcher icons
      run: |
        # Install imagemagick if not already installed
        sudo apt-get install -y imagemagick
        
        # Create all required mipmap directories
        mkdir -p android/app/src/main/res/mipmap-mdpi
        mkdir -p android/app/src/main/res/mipmap-hdpi
        mkdir -p android/app/src/main/res/mipmap-xhdpi
        mkdir -p android/app/src/main/res/mipmap-xxhdpi
        mkdir -p android/app/src/main/res/mipmap-xxxhdpi
        
        # Generate launcher icons at different resolutions
        convert icons/512.png -resize 48x48   android/app/src/main/res/mipmap-mdpi/ic_launcher.png
        convert icons/512.png -resize 72x72   android/app/src/main/res/mipmap-hdpi/ic_launcher.png
        convert icons/512.png -resize 96x96   android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
        convert icons/512.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert icons/512.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        
        echo "Launcher icons generated for all densities"

    # --- Copy assets dynamically ---
    - name: Copy assets to Android project
      run: |
        rm -rf android/app/src/main/assets
        cp -R assets android/app/src/main/
        echo "Assets copied successfully"

    # --- Generate shader headers dynamically ---
    - name: Generate shader headers dynamically
      run: |
        mkdir -p android/app/src/main/cshaders
        if ls shaders/*.hlsl 1> /dev/null 2>&1; then
          for f in shaders/*.hlsl; do
              base=$(basename "$f" .hlsl)
              file_to_c "$f" "shader_${base}" "android/app/src/main/cshaders/${base}.c" "android/app/src/main/cshaders/${base}.h"
              echo "Generated shader header for $base"
          done
        else
          echo "No HLSL shaders found"
        fi

    # --- Generate mod headers dynamically ---
    - name: Generate mod headers dynamically
      run: |
        mkdir -p android/app/src/main/cmods
        if ls mods/*.nrm 1> /dev/null 2>&1; then
          for f in mods/*.nrm; do
              base=$(basename "$f" .nrm)
              file_to_c "$f" "$base" "android/app/src/main/cmods/${base}.c" "android/app/src/main/cmods/${base}.h"
              echo "Generated mod header for $base"
          done
        else
          echo "No .nrm mods found"
        fi

    # --- Generate patches_bin.c dynamically ---
    - name: Generate patches_bin.c dynamically
      run: |
        mkdir -p android/app/src/main/cpatches
        if [ -f patches/patches.bin ]; then
          file_to_c patches/patches.bin mm_patches_bin android/app/src/main/cpatches/patches_bin.c android/app/src/main/cpatches/patches_bin.h
          echo "Generated patches_bin header"
        else
          echo "patches/patches.bin not found, skipping"
        fi

    # --- Cache Gradle dependencies ---
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    # --- Build APK ---
    - name: Build Android APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    # --- COMPREHENSIVE APK DEBUGGING ---
    - name: Debug APK - Basic Info
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "APK BASIC INFORMATION"
        echo "=========================================="
        
        if [ ! -f "$APK_PATH" ]; then
          echo "âŒ APK NOT FOUND at $APK_PATH"
          exit 1
        fi
        
        echo "âœ… APK exists at: $APK_PATH"
        echo "File size: $(du -h $APK_PATH | cut -f1)"
        echo "File permissions: $(ls -lh $APK_PATH)"
        echo ""
        
        # Check if it's a valid ZIP file
        echo "=========================================="
        echo "ZIP STRUCTURE CHECK"
        echo "=========================================="
        if unzip -t "$APK_PATH" > /dev/null 2>&1; then
          echo "âœ… APK is a valid ZIP archive"
        else
          echo "âŒ APK is NOT a valid ZIP archive - this will cause parse errors!"
          exit 1
        fi
        echo ""

    - name: Debug APK - Package Info
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "PACKAGE INFORMATION (aapt)"
        echo "=========================================="
        $ANDROID_HOME/build-tools/34.0.0/aapt dump badging "$APK_PATH" || echo "âŒ aapt dump badging failed"
        echo ""

    - name: Debug APK - Manifest
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "ANDROID MANIFEST"
        echo "=========================================="
        $ANDROID_HOME/build-tools/34.0.0/aapt dump xmltree "$APK_PATH" AndroidManifest.xml | head -100 || echo "âŒ Failed to dump manifest"
        echo ""

    - name: Debug APK - Contents List
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "APK CONTENTS (first 50 files)"
        echo "=========================================="
        unzip -l "$APK_PATH" | head -50
        echo ""
        
        echo "=========================================="
        echo "NATIVE LIBRARIES"
        echo "=========================================="
        unzip -l "$APK_PATH" | grep "lib/" || echo "No native libraries found"
        echo ""

    - name: Debug APK - Signing Info
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "APK SIGNATURE VERIFICATION"
        echo "=========================================="
        if $ANDROID_HOME/build-tools/34.0.0/apksigner verify -v "$APK_PATH" 2>&1; then
          echo "âœ… APK signature is VALID"
        else
          echo "âš ï¸ APK signature verification failed (may be OK for debug builds)"
        fi
        echo ""
        
        echo "=========================================="
        echo "DETAILED SIGNATURE INFO"
        echo "=========================================="
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify --print-certs "$APK_PATH" 2>&1 || echo "Could not get signature details"
        echo ""

    - name: Debug APK - Alignment Check
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "APK ALIGNMENT CHECK"
        echo "=========================================="
        if $ANDROID_HOME/build-tools/34.0.0/zipalign -c -v 4 "$APK_PATH" 2>&1; then
          echo "âœ… APK is properly aligned"
        else
          echo "âš ï¸ APK is not aligned (may cause installation issues on some devices)"
        fi
        echo ""

    - name: Debug APK - Minimum Requirements
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "MINIMUM ANDROID REQUIREMENTS"
        echo "=========================================="
        $ANDROID_HOME/build-tools/34.0.0/aapt dump badging "$APK_PATH" | grep -E "sdkVersion|targetSdkVersion|native-code"
        echo ""
        
        echo "=========================================="
        echo "PERMISSIONS"
        echo "=========================================="
        $ANDROID_HOME/build-tools/34.0.0/aapt dump permissions "$APK_PATH" || echo "Could not dump permissions"
        echo ""

    - name: Debug APK - Extract and Verify AndroidManifest.xml
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "EXTRACTING ANDROIDMANIFEST.XML"
        echo "=========================================="
        
        # Create temp directory
        mkdir -p /tmp/apk-debug
        
        # Extract manifest
        unzip -q "$APK_PATH" -d /tmp/apk-debug AndroidManifest.xml
        
        if [ -f /tmp/apk-debug/AndroidManifest.xml ]; then
          echo "âœ… AndroidManifest.xml found in APK"
          echo "Size: $(du -h /tmp/apk-debug/AndroidManifest.xml | cut -f1)"
          
          # Try to decode it
          echo ""
          echo "Decoded Manifest (via aapt):"
          $ANDROID_HOME/build-tools/34.0.0/aapt dump xmltree "$APK_PATH" AndroidManifest.xml | head -200
        else
          echo "âŒ AndroidManifest.xml NOT FOUND in APK - this will cause parse errors!"
          exit 1
        fi

    - name: Debug APK - Check for Common Issues
      run: |
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        
        echo "=========================================="
        echo "CHECKING FOR COMMON ISSUES"
        echo "=========================================="
        
        # Check for resources.arsc
        if unzip -l "$APK_PATH" | grep -q "resources.arsc"; then
          echo "âœ… resources.arsc present"
        else
          echo "âš ï¸ resources.arsc missing - may cause issues"
        fi
        
        # Check for classes.dex
        if unzip -l "$APK_PATH" | grep -q "classes.dex"; then
          echo "âœ… classes.dex present"
        else
          echo "âŒ classes.dex MISSING - APK will not run!"
        fi
        
        # Check for META-INF
        if unzip -l "$APK_PATH" | grep -q "META-INF/"; then
          echo "âœ… META-INF directory present"
        else
          echo "âš ï¸ META-INF directory missing"
        fi
        
        echo ""
        echo "=========================================="
        echo "APK DEBUGGING COMPLETE"
        echo "=========================================="

    # --- Upload APK artifact ---
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: SF64RCA-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        if-no-files-found: error
        
    # --- Upload debug logs ---
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          android/app/build/outputs/logs/
          android/build/reports/
        if-no-files-found: ignore

    # --- Create build summary ---
    - name: Create build summary
      if: success()
      run: |
        echo "## ðŸŽ® Build Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### APK Details" >> $GITHUB_STEP_SUMMARY
        APK_PATH=android/app/build/outputs/apk/debug/app-debug.apk
        APK_SIZE=$(du -h $APK_PATH | cut -f1)
        echo "- **Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
        echo "- **Location:** \`$APK_PATH\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Debug Info" >> $GITHUB_STEP_SUMMARY
        echo "Check the job output above for detailed APK debugging information." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download" >> $GITHUB_STEP_SUMMARY
        echo "The APK is available in the workflow artifacts section above." >> $GITHUB_STEP_SUMMARY