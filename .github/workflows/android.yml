name: Android Build

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: ${{ github.workspace }}/android-sdk
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    # --- Setup JDK ---
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    # --- Install Android SDK + NDK ---
    - name: Download Android SDK Command Line Tools
      run: |
        mkdir -p $ANDROID_HOME/cmdline-tools
        curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
        rm cmdline-tools.zip

    - name: Install SDK components
      run: |
        yes | $ANDROID_HOME/cmdline-tools/cmdline-tools/bin/sdkmanager --sdk_root=$ANDROID_HOME "platforms;android-34" "platform-tools" "build-tools;34.0.0" "ndk;25.1.8937393"

    # --- Pre-generate host-only files ---
    - name: Build host tools (N64Recomp, file_to_c)
      run: |
        mkdir -p build-host
        cd build-host
        cmake ../ -DCMAKE_BUILD_TYPE=Release
        cmake --build . --target N64Recomp

    - name: Generate patches_bin.c and other host files
      run: |
        ./build-host/N64Recomp ../patches/patches.toml
        file_to_c ../patches/patches.bin mm_patches_bin ../RecompiledPatches/patches_bin.c ../RecompiledPatches/patches_bin.h
        # Add shader generation if needed
        # build_vertex_shader ...

    # --- Android Gradle build ---
    - name: Build Android APK
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: Starfox64Recompiled-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk